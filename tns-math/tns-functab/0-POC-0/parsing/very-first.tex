\documentclass[12pt]{article}

\ExplSyntaxOn

% -- FUNCTABLE ENV. -- %

\NewDocumentEnvironment{ functable }{ b }{%
  \tns_functab_functable:n { #1 }
}{}


\cs_new:Npn \tns_functab_functable:n #1 {
  \tns_core_DSL_ctxt_parser:nn { functable } { #1 } 

  \bigskip\par
  NEW ~ DATA ~ \int_use:N \g_tns_functab_id_int

  \par
  TODO
}


% -- DSL - L3 -- %

\tl_new:N   \g_tns_functab_semicolon_tl
\tl_gset:Nn \g_tns_functab_semicolon_tl { ; }

\tl_new:N   \g_tns_functab_colon_tl
\tl_gset:Nn \g_tns_functab_colon_tl { : }

\cs_generate_variant:Nn \seq_set_split:Nnn { NV }

\AtBeginDocument {
  \tl_gset_rescan:NnV \g_tns_functab_semicolon_tl
                      {}
                      \g_tns_functab_semicolon_tl

  \tl_gset_rescan:NnV \g_tns_functab_colon_tl
                      {}
                      \g_tns_functab_colon_tl
}


% :: AGNOSTIC PARSERS :: %

\int_new:N  \g_tns_functab_id_int
\int_set:Nn \g_tns_functab_id_int { 0 }

\int_new:N \l_tns_core_ctxt_nb_line_int
\seq_new:N \l_tns_core_ctxts_seq
\tl_new:N  \l_tns_core_current_ctxt_tl


\cs_new:Npn \tns_core_DSL_ctxt_parser:nn #1#2 {
% The ID nb. of the env.
  \int_gincr:N \g_tns_functab_id_int

% Line by line parsing.
%
% Lines are semi-colon separated.
  \seq_set_split:NVn \l_tns_core_ctxts_seq
                      \g_tns_functab_semicolon_tl
                      { #2 }

  \int_zero:N \l_tns_core_ctxt_nb_line_int

  \seq_map_inline:Nn \l_tns_core_ctxts_seq {
    \bigskip\par

    \int_incr:N \l_tns_core_ctxt_nb_line_int

    Line ~ \int_use:N \l_tns_core_ctxt_nb_line_int
    \par

% Get the context and its content.
    \seq_set_split:Nnn \l_tmpa_seq { = } { ##1 }

    \int_set:Nn \l_tmpa_int {\seq_count:N \l_tmpa_seq}

    \quad
    \int_case:nnF { \int_use:N \l_tmpa_int } {
      { 1 } {
        LAST - CTXT: ~
        (\tl_use:N \l_tns_core_current_ctxt_tl)
      }
      { 2 } {
        \seq_pop_left:NN \l_tmpa_seq \l_tns_core_current_ctxt_tl

        NEW - CTXT: ~
        (\tl_use:N \l_tns_core_current_ctxt_tl)
      }
    }{
      ILLEGAL!
    }

% Get the optional label and its content.
    \seq_pop_left:NN \l_tmpa_seq \l_tmpa_tl

    \seq_set_split:NVV \l_tmpa_seq
                       \g_tns_functab_colon_tl
                       \l_tmpa_tl

    \int_set:Nn \l_tmpa_int {\seq_count:N \l_tmpa_seq}

    \par\quad
    \int_case:nnF { \int_use:N \l_tmpa_int } {
      { 1 } {
        NO LABEL
      }
      { 2 } {
        \seq_pop_left:NN \l_tmpa_seq \l_tmpa_tl

        LABEL: ~
        $(\tl_use:N \l_tmpa_tl)$
      }
    }{
      ILLEGAL!
    }

    \par\quad

    \seq_pop_left:NN \l_tmpa_seq \l_tmpa_tl

    VAL: ~
    $(\tl_use:N \l_tmpa_tl)$
  }
}

\ExplSyntaxOff


\begin{document}

\begin{functable}
    xvals =    t : 1 , 20 , 300 , 4000 ;
    imgs  = f(t) : a , bb , ccc , dddd ;
            g(t) : U , VV , WWW , XXXX
\end{functable}

\end{document}

